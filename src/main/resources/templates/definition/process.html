<html layout:decorate="~{layout_page}">
<head>
    <style>
        .wj-header {
            text-align: center !important;
        }
    </style>
</head>
<th:block layout:fragment="content">
    <div class="layout-contents">

        <div class="page-title-wrap">
            <div class="left">
                <h2>공정 정보</h2>
                <a title="북마크" class="bookmark toggle">
                    내 메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>기준정보</li>
                <li>공정정보</li>
            </ul>
        </div>

        <div style="display: flex; gap: 5px">
            <section class="section" style="width: 60%;">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                <label>공정명</label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input type="text" class="form-control2" id="txtProcess" name="txtProcess">
                                </div>
                            </dd>
                        </dl>

                        <dl>
                            <dt><span class="eq"></span></dt>
                            <dd>
                                <li>
                                    <a class="btn btn-delete" title="검색" id="btnSearch">
                                        <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                        검색
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                </div>

                <div class="container-fluid">
                    <p id="selectedItem"></p>
                    <div id="theGrid" style=""></div>
                </div>
            </section>

            <div class="tab-wrap" style="width: 40%;">
                <ul class="tab-links">
                    <li><a href="#tab_basic">기본정보</a></li>
                    <li><a href="#tab_defect_type">공장별부적합유형</a></li>
                    <li><a href="#tab_stop_cause">공정별비가동유형</a></li>
                </ul>
                <div>
                    <section class="tab-item" id="tab_basic" style="border-top-left-radius: 0;">
                        <div class="section-top">
                            <div class="button-wrap">
                                <ul>
                                    <li>
                                        <!-- <a class="btn btn-edit" title="작업 지시 상세" id="">
                                             <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">
                                             신규등록
                                         </a>-->
                                        <button type="button" class="btn-excellt btn-default" id="btnNew" name="btnNew" style="width: 115px; height: 36px;"><i
                                                class="fas fa-plus"></i>신규등록
                                        </button>
                                    </li>

                                    <li>
                                        <!--<a class="btn btn-edit" title="작업 지시 상세" id="">
                                            <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">
                                            삭제
                                        </a>-->
                                        <button type="button" class="btn-delete btn-danger" id="btnDel" style="width: 115px; height: 36px;"><i class="fas fa-trash"></i>삭제
                                        </button>
                                    </li>

                                    <li>
                                        <!-- <a class="btn btn-edit" title="작업 지시 상세" id="">
                                             <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">
                                             저장
                                         </a>-->
                                        <button type="button" class="btn-excellt btn-default" id="btnSave" style="width: 115px; height: 36px;"><i class="fas fa-save"></i>저장
                                        </button>
                                    </li>

                                </ul>
                            </div>

                            <div class="table-wrap" style=" overflow-x: auto;">
                                <form id="processForm">
                                    <table class="write-table"
                                           style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                                        <caption style="text-align: left; margin-bottom: 8px;">상세테이블</caption>
                                        <input type="hidden" id="id" name="id"/>
                                        <col class="wp20">
                                        <col class="wp80">
                                        <tbody>
                                        <tr>
                                            <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                                <label for="factory_id"><span class="eq">*</span>공장</label>
                                            </th>
                                            <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                                <select  id="factory_id" name="factory_id"
                                                        style="width: 100%;"></select>
                                            </td>

                                        </tr>
                                        <tr>
                                            <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                                <label for="process_type"><span class="eq">*</span>공정구분</label>
                                            </th>
                                            <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                                <input type="text" id="process_type" name="process_type"
                                                       style="width: 100%;">
                                                <ul id="suggestions-process_type" class="suggestions-list"></ul>
                                            </td>

                                        </tr>
                                        <tr>
                                            <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                                <label for="process_code"><span class="eq">*</span>공정코드</label>
                                            </th>
                                            <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                                <input type="text" style="width: 100%;" id="process_code"
                                                       name="process_code">
                                            </td>

                                        </tr>
                                        <tr>
                                            <th style="width: 7%; padding: 5px; border: 1px solid #ddd; text-align: center;">
                                                <label for="process_name"><span class="eq">*</span>공정명</label>
                                            </th>
                                            <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                                <input type="text" style="width: 100%;" id="process_name"
                                                       name="process_name">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                                <label for="description">설명</label>
                                            </th>
                                            <td style="width: 15%; padding: 5px; border: 1px solid #ddd;" colspan="7">
                                                <!--<textarea id="description" name="description"></textarea>-->
                                                <input type="text" id="description" name="description" style="width: 100%;">
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </form>
                            </div>

                        </div>
                    </section>

                    <section class="tab-item" id="tab_defect_type" style="border-top-left-radius: 0;">
                        <div class="section-top">
                            <div class="button-wrap">
                                <ul>
                                    <li>
                                        <select  id="cboDefectType" name="cboDefectType" style="width: 220px;"></select>
                                    </li>
                                    <li>
                                        <button type="button" class="btn-excellt btn-default" id="btnAddDefectType"
                                                style="height: 36px; width:115px;"><i class="fas fa-plus"></i>추가</button>
                                    </li>
                                    <li>
                                        <button type="button" class="btn-delete btn-cancel y_write_auth btn-danger" id="btnDelDefectType"
                                                style="float:none; height: 36px; width:115px;"><i class="fas fa-trash">삭제</i>
                                        </button>
                                    </li>
                                    <li>
                                        <button type="button" class="btn-excellt btn-default" id="btnSaveDefectType"
                                                style="float:none; height: 36px; width:115px;"><i class="fas fa-save">저장</i>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="container-fluid">
                            <p id="selectedItem"></p>
                            <div id="proc_defect_type_grid" style=""></div>
                        </div>
                    </section>


                    <section class="tab-item" id="tab_stop_cause" style="border-top-left-radius: 0;">
                        <div class="section-top">
                            <div class="button-wrap">
                                <ul>
                                    <li>
                                        <select class="s-150" id="cboStopCause" name="cboStopCause" style="width: 220px;"></select>
                                    </li>
                                    <li>
                                        <button type="button" class="btn-excellt btn-default" id="btnAddStopCause"
                                                style="height: 36px; width:115px;"><i class="fas fa-plus"></i>추가</button>
                                    </li>
                                    <li>
                                        <button type="button" class="btn-delete btn-cancel y_write_auth btn-danger" id="btnDelStopCause"
                                                style="float:none; height: 36px; width:115px;"><i class="fas fa-trash">삭제</i>
                                        </button>
                                    </li>
                                    <li>
                                        <button type="button" class="btn-excellt btn-default" id="btnSaveStopCause"
                                                style="float:none; height: 36px; width:115px;"><i class="fas fa-save">저장</i>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="container-fluid">
                            <p id="selectedItem"></p>
                            <div id="proc_stop_cause_grid" style=""></div>
                        </div>
                    </section>

                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>
    <script type="text/javascript">


        var theGrid;
        var viewdata;
        var theGrid2;
        var viewdata2;
        var theGrid3;
        var viewdata3;

        let columns = [
            { binding: 'id', header: '번호', width: 80, align: 'center',visible:false },
            {binding: 'process_type', header: '공정구분', width: 150, align: 'left'},
            {binding: 'process_code', header: '공정코드', width: 150, align: 'left'},
            {binding: 'process_name', header: '공정명', width: 200, align: 'left'},
            {binding: 'factory_name', header: '공장', width: 150, align: 'left'},
            {binding: 'description', header: '설명', width: 150, align: 'left', visible: false},
            {binding: '', header: '', width: "*", align: 'left'},
        ];

        let columns2 = [
            {binding: 'id', header: '번호', width: 80, align: 'right', visible:false},
            {binding: 'defect_type_id', header: '부적합유형번호', width: 150, align: 'center'},
            {binding: 'defect_type_code', header: '부적합유형코드', width: 150, align: 'center'},
            {binding: 'defect_type_name', header: '부적합유형명', width: 200, align: 'center'},
            {binding: '', header: '', width: "*", align: 'center'},
        ];

        let columns3 = [
            {binding: 'id', header: '번호', width: 150, align: 'left', visible:false},
            {binding: 'stop_cause_id', header: '비가동유형번호', width: 150, align: 'center'},
            {binding: 'stop_cause_name', header: '비가동유형명', width: 200, align: 'center'},
            {binding: '', header: '', width: "*", align: 'center'},
        ]

        document.readyState === 'complete' ? init() : window.onload = init;

        function init() {
            let data2 = [];
            let process_name = $('#txtProcess').val();

            $.ajax({
                url: '/api/definition/process/read',
                type: 'GET',
                data: {
                    'process_name': process_name,
                    spjangcd: sessionStorage.getItem('spjangcd'),
                },
                async: false,
                success: function (data) {
                    data2 = data.data;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                   /* console.error('Error fetching log_count data:', textStatus, errorThrown);*/
                }
            })

            viewdata = new wijmo.collections.CollectionView(data2);

            theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                autoGenerateColumns: false,
                showMarquee: true,
                columns: columns,
                isReadOnly: true,
                itemsSource: viewdata
            });

            theGrid.hostElement.addEventListener('dblclick', function (e) {
                let selectedItem = theGrid.selectedItems[0];
                /*console.log(selectedItem);*/

                document.getElementById('id').value = selectedItem.id;
                document.getElementById('process_type').value = selectedItem.process_type;
                document.getElementById('process_code').value = selectedItem.process_code;
                document.getElementById('process_name').value = selectedItem.process_name;
                document.getElementById('description').value = selectedItem.description;


                function setSelectValue(selectId, valueToMatch) {
                    let selectElement = document.getElementById(selectId);
                    if (selectElement) {
                        for (let option of selectElement.options) {
                            option.selected = option.text === valueToMatch;
                        }
                    }
                }

                setSelectValue('factory_id', selectedItem. factory_name);

                 /*setButtonState();*/
                showProcDefectType(selectedItem.id);
                showProcStopCause(selectedItem.id);
            });

            theGrid.rowHeaders.columns.splice(0, 1);
            /*  new FlexGridContextMenu(theGrid);*/
            showProcDefectType();
            showProcStopCause();
        }


      /* function setButtonState() {
            let pk = $('#id').val();
            $('#btnNew').prop('disabled', false);
            $('#btnSave').prop('disabled', false);
            if (pk) {
                $('#btnDel').prop('disabled', false);
                $('#btnSaveDefectType').prop('disabled', false);
                $('#btnSaveStopCause').prop('disabled', false);
            }
            else {
                $('#btnDel').prop('disabled', true);
                $('#btnSaveDefectType').prop('disabled', true);
                $('#btnSaveStopCause').prop('disabled', true);
            }
        }*/

        // 공정 목록 조회
        function searchMainData() {
            let process_name = $('#txtProcess').val();

            $.ajax({
                url: '/api/definition/process/read',
                type: 'GET',
                data: {
                    'process_name': process_name,
                    spjangcd: sessionStorage.getItem('spjangcd'),
                },
                async: false,
                success: function (result) {
                    if (result.success) {
                        grid_binding(result.data);
                    } else {
                        console.log("Error occurred");
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching log_list data:', textStatus, errorThrown);

                }
            });


            $('#processForm')[0].reset();
            $('#processForm').find('#id').val('');

            // $('#processForm').find('input, select').each(function () {
            //     if (!$(this).is(':disabled')) {
            //         $(this).attr('disabled', 'disabled');
            //     }
            // });

/*            setButtonState();*/
        }

        // 공정 상세정보 조회
        function showDetailProcess(id) {
            let param = {'process_id': id, 'action': 'detail'};
            let result = AjaxUtil.getSyncData(this.url + '/detail', param);

            if (result != null) {
                FormUtil.BindDataForm(result.data, $('#processForm'));
            }
            //page.setButtonDisable(false, false, false);
            page.setButtonState();
        }


        function grid_binding(data) {
            if (!Array.isArray(data)) {
                console.error('데이터가 배열 형식이 아닙니다:', data);
                return;
            }

            let menulogData = data.map(item => ({
                id: item.id,
                process_type:item.process_type,
                process_code: item.process_code,
                process_name:item.process_name,
                factory_name:item.factory_name
            }));

            if (typeof theGrid === 'undefined' || typeof viewdata === 'undefined') {
                console.error('theGrid 또는 viewdata가 정의되지 않았습니다.');
                return;
            }

            theGrid.columns.clear();
            theGrid.autoGenerateColumns = false;

            // columns 배열이 정의되어 있는지 확인
            if (typeof columns === 'undefined' || !Array.isArray(columns)) {
                console.error('columns 배열이 정의되지 않았습니다.');
                return;
            }

            columns.forEach(columnDef => {
                var col = new wijmo.grid.Column(columnDef);
                theGrid.columns.push(col);
            });

            viewdata = new wijmo.collections.CollectionView(menulogData);

            theGrid.itemsSource = viewdata;
            theGrid.refresh();
        }

        // 공정 정보 저장
        function saveProcess() {
            let url = '/api/definition/process/save';

            let data = FormUtil.extractForm($('#processForm'));

            // 필수입력 check routine

            if(!data.factory_id){
                Alert.alert('','공장을 선택해주세요')
                $('#processForm #factory_id').focus();
                return;
            }else if(!data.process_type){
                Alert.alert('', '공정구분을 선택해주세요.');
                $('#processForm #process_type').focus();
                return;
            } else if (!data.process_code) {
                Alert.alert('', '공정 코드를 입력해주세요.');
                $('#processForm #process_code').focus();
                return;
            }else if(!data.process_name){
                Alert.alert('', '공정명을 입력해주세요.');
                $('#processForm #process_name').focus();
                return;
            }

            data.spjangcd=sessionStorage.getItem('spjangcd');

            Alert.confirm('', '저장하시겠습니까?', function () {
                let fnSuccess = function (result) {
                    if (result.success) {
                        Alert.alert('', '저장되었습니다');
                        searchMainData(); // 저장 후 데이터 갱신
                    } else {
                        Alert.alert('저장 실패', result.message);
                        console.error('저장 실패:', result.message);
                    }
                };

                // 데이터 저장 요청
                AjaxUtil.postAsyncData(url, data, fnSuccess);
            });


        }

        // 공정 정보 삭제
        function deleteProcess() {
            let url = '/api/definition/process/delete';
            //let url = this.baseUrl + '?action=delete';
            let id = $('#processForm').find('#id').val();
            let data = {'id': id};

            Alert.confirm('', '삭제하시겠습니까?', function () {
                let fnSuccess = function (result) {
                    if (result.success) {
                        Alert.alert('', '삭제되었습니다');
                        searchMainData(); // 저장 후 데이터 갱신
                    } else {
                        Alert.alert('삭제 실패', result.message);
                        console.error('저장 실패:', result.message);
                    }
                };
                // 데이터 저장 요청
                AjaxUtil.postAsyncData(url, data, fnSuccess);
            });
        }

        // 공정별부적합유형
        function showProcDefectType(idx) {
            let data2 = [];
            let _this = this;
            let id = idx;
            /*console.log('id값 확인',id);*/

            $.ajax({
                url: '/api/definition/process/proc_defect_type_list',
                type: 'GET',
                data: {
                    'proc_pk': id,
                    spjangcd:sessionStorage.getItem('spjangcd')
                },
                async: false,
                success: function (data) {
                    /*console.log('부적합유형데이터',data);*/
                    data2 = data.data;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    /*console.error('Error fetching log_count data:', textStatus, errorThrown);*/
                }
            })

            // 기존 그리드 초기화
            if (theGrid2) {
                theGrid2.dispose();  // 기존 그리드를 제거합니다.
            }

            viewdata2 = new wijmo.collections.CollectionView(data2);

            theGrid2 = new wijmo.grid.FlexGrid('#proc_defect_type_grid', {
                autoGenerateColumns: false,
                showMarquee: true,
                columns: columns2,
                isReadOnly: true,
                itemsSource: viewdata2
            });

            theGrid2.rowHeaders.columns.splice(0, 1);
        }


        //공장별 부적합유형 추가 기능
        function addDefectTypeRow() {
            let row = {};
            let defect_type_pk = $('#cboDefectType').val();
            let already = false;

            // 현재 FlexGrid의 데이터 가져오기
            let items = theGrid2.itemsSource;

            // CollectionView인 경우 배열로 변환
            if (items instanceof wijmo.collections.CollectionView) {
                items = items.items;
            }

            if (!Array.isArray(items)) {
                console.error('itemsSource가 배열이나 CollectionView가 아닙니다:', items);
                return;
            }
            /*console.log(items);*/

            // 중복 체크
            items.forEach(function (item) {
                if (item.defect_type_id == defect_type_pk) {
                    already = true;
                }
            });

            if (already) {
                Alert.alert('','이미 추가된 항목입니다.');
                return;
            }

            // 새로운 행 데이터 추가
            row["defect_type_id"] = defect_type_pk;
            row["defect_type_name"] = $("#cboDefectType option:selected").text();

            // itemsSource에 새로운 데이터 추가
            items.push(row);

            // FlexGrid 업데이트
            theGrid2.itemsSource = new wijmo.collections.CollectionView(items);
        }


        //공정별 부적합유형 저장
        function saveDefectType() {
            let _this = this;
            let url = '/api/definition/process';

            // Wijmo FlexGrid에서 데이터 가져오기
            let grid_data = JSON.stringify(theGrid2.collectionView.items);

            let param = {
                'proc_pk': $('#id').val(),
                Q: grid_data
            };

            let fnSuccess = function (result) {
                if (result.success) {
                    Alert.alert('', '저장되었습니다');
                    showProcDefectType(); // 저장 후 데이터 갱신
                } else {
                    Alert.alert('저장 실패', result.message);
                    console.error('저장 실패:', result.message);
                }
            };

            // 비동기 요청으로 데이터 전송
            AjaxUtil.postAsyncData(url + "/save_proc_defect_type", param, fnSuccess);
        }


        // 공정별비가동유형
        function showProcStopCause(idx) {
            let data2 = [];
            let _this = this;
            let id = idx;
            /*console.log('id값 확인',id);*/

            $.ajax({
                url: '/api/definition/process/proc_stop_cause_list',
                type: 'GET',
                data: {
                    'proc_pk': id,
                    spjangcd:sessionStorage.getItem('spjangcd')
                },
                async: false,
                success: function (data) {
                    /*console.log('비가동유형',data);*/
                    data2 = data.data;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    /*console.error('Error fetching log_count data:', textStatus, errorThrown);*/
                }
            })

            // 기존 그리드 초기화
            if (theGrid3) {
                theGrid3.dispose();  // 기존 그리드를 제거합니다.
            }

            viewdata3 = new wijmo.collections.CollectionView(data2);

            theGrid3 = new wijmo.grid.FlexGrid('#proc_stop_cause_grid', {
                autoGenerateColumns: false,
                showMarquee: true,
                columns: columns3,
                isReadOnly: true,
                itemsSource: viewdata3
            });

            theGrid3.rowHeaders.columns.splice(0, 1);
        }


        function addStopCauseRow() {
            let row = {};
            let stop_cause_pk = $('#cboStopCause').val();
            let already = false;

            // 현재 FlexGrid의 데이터 가져오기
            let items = theGrid3.itemsSource;

            // CollectionView인 경우 배열로 변환
            if (items instanceof wijmo.collections.CollectionView) {
                items = items.items;
            }

            if (!Array.isArray(items)) {
                console.error('itemsSource가 배열이나 CollectionView가 아닙니다:', items);
                return;
            }

            // 중복 체크
            items.forEach(function (item) {
                if (item.stop_cause_id == stop_cause_pk) {
                    already = true;
                }
            });

            if (already) {
                Alert.alert('','이미 추가된 항목입니다.');
                return;
            }

            // 새로운 행 데이터 추가
            row["stop_cause_id"] = stop_cause_pk;
            row["stop_cause_name"] = $("#cboStopCause option:selected").text();

            // itemsSource에 새로운 데이터 추가
            items.push(row);

            // FlexGrid 업데이트
            theGrid3.itemsSource = new wijmo.collections.CollectionView(items);

            /* theGrid3.getList().forEach(function (row) {
                 if (row.stop_cause_id == stop_cause_pk)
                     already = true;
             });
             if (already)
                 return;

             row["stop_cause_id"] = stop_cause_pk;
             row["stop_cause_name"] = $("#cboStopCause option:selected").text();

             theGrid3.addRow(
                 row,
                 'last',
                 {__index: undefined}
             );*/
        }




        //공정별 비가동유형 저장
        function saveStopCause() {
            let _this = this;
            let url = '/api/definition/process';

            // Wijmo FlexGrid에서 데이터 가져오기
            let grid_data = JSON.stringify(theGrid3.collectionView.items);

            let param = {
                proc_pk: $('#id').val(),
                Q: grid_data
            };

            let fnSuccess = function (result) {
                if (result.success) {
                    Alert.alert('', '저장되었습니다');
                    showProcStopCause(); // 저장 후 데이터 갱신
                } else {
                    Alert.alert('저장 실패', result.message);
                    console.error('저장 실패:', result.message);
                }
            };

            AjaxUtil.postAsyncData(url + "/save_proc_stop_cause", param, fnSuccess);
        }

        // 자동완성
        let debounceTimeout;
        let selectedSuggestionIndex = -1;
        let suggestionsVisible = false;

        function fetchSuggestions(inputId, apiUrl, suggestionId) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const inputField = document.getElementById(inputId);
                let suggestionsList = document.getElementById(suggestionId);

                if (!inputField || !suggestionsList) return;

                const inputClearDiv = inputField.parentElement;
                inputClearDiv.appendChild(suggestionsList);

                const query = inputField.value;
                if (query.length > 0) {
                    fetch(`${apiUrl}?query=${encodeURIComponent(query)}&field=${encodeURIComponent(inputId)}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            const previousSelectedText = (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < data.length) ? data[selectedSuggestionIndex] : null;
                            suggestionsList.innerHTML = '';
                            if (data.length > 0) {
                                suggestionsVisible = true;
                                suggestionsList.style.display = 'block'; // 결과가 있을 때만 표시
                                data.forEach((item, index) => {
                                    let li = document.createElement('li');
                                    li.textContent = item;
                                    li.setAttribute('data-index', index);
                                    li.onclick = function () {
                                        document.getElementById(inputId).value = this.textContent;
                                        suggestionsList.innerHTML = '';
                                        suggestionsList.style.display = 'none';
                                        suggestionsVisible = false;
                                    };
                                    suggestionsList.appendChild(li);
                                    // 이전에 선택한 항목을 다시 선택 상태로 설정
                                    if (item === previousSelectedText) {
                                        selectedSuggestionIndex = index;
                                        li.classList.add('selected');
                                    }
                                });
                            } else {
                                suggestionsList.style.display = 'none'; // 결과가 없으면 숨김
                                suggestionsVisible = false;
                                selectedSuggestionIndex = -1;
                            }
                        })
                        .catch(error => {
                            console.error('Fetch error:', error);
                            suggestionsList.style.display = 'none'; // 오류 시 숨김
                            suggestionsVisible = false;
                            selectedSuggestionIndex = -1;
                        });
                } else {
                    suggestionsList.innerHTML = '';
                    suggestionsList.style.display = 'none';
                    suggestionsVisible = false;
                    selectedSuggestionIndex = -1;
                }
            }, 300);  // 300ms의 디바운스 타임 적용
        }

        // 자동완성 기능
        function initializeAutoComplete(inputId, apiUrl, suggestionId) {
            const inputField = document.getElementById(inputId);

            let preventFetchOnEnter = false;  // Enter 키로 선택했을 때 검색을 방지하기 위한 플래그

            inputField.addEventListener('keyup', (event) => {
                if (event.key !== 'Enter' && event.key !== 'ArrowDown' && event.key !== 'ArrowUp' && !preventFetchOnEnter) {
                    fetchSuggestions(inputId, apiUrl, suggestionId);
                }
                // Enter 키가 눌렸을 경우에는 검색을 방지
                preventFetchOnEnter = false;  // 플래그 초기화
            });

            inputField.addEventListener('keydown', function (event) {
                const suggestionsList = document.getElementById(suggestionId);
                const items = suggestionsList.getElementsByTagName('li');

                if (suggestionsVisible) {
                    if (event.key === 'ArrowDown') {
                        // 아래 화살표 키를 누르면
                        event.preventDefault(); // 기본 동작 방지
                        selectedSuggestionIndex = (selectedSuggestionIndex + 1) % items.length;
                        updateSuggestionSelection(items);
                    } else if (event.key === 'ArrowUp') {
                        // 위 화살표 키를 누르면
                        event.preventDefault(); // 기본 동작 방지
                        selectedSuggestionIndex = (selectedSuggestionIndex - 1 + items.length) % items.length;
                        updateSuggestionSelection(items);
                    } else if (event.key === 'Enter') {
                        // Enter 키를 누르면
                        if (selectedSuggestionIndex >= 0) {
                            event.preventDefault(); // 기본 동작 방지
                            items[selectedSuggestionIndex].click();
                            preventFetchOnEnter = true;  // 엔터로 선택한 후 검색 방지
                            suggestionsVisible = false; // Enter 키를 누르면 선택을 확정하고 목록을 숨김
                            // inputField.blur(); // 입력 필드 포커스 해제
                        }
                    } else if (event.key === 'Escape') {
                        // Escape 키를 누르면
                        suggestionsList.style.display = 'none';
                        suggestionsVisible = false;
                    }
                }
            });

            // 포커스 해제 시 자동 완성 목록 숨기기
            inputField.addEventListener('blur', function () {
                setTimeout(function () {
                    const suggestionsList = document.getElementById(suggestionId);
                    suggestionsList.style.display = 'none';
                    suggestionsVisible = false;
                }, 300); // 300ms 지연 시간
            });

            // 마우스 클릭으로 선택 시에도 검색 방지
            document.getElementById(suggestionId).addEventListener('click', function (event) {
                if (event.target.tagName === 'LI') {
                    preventFetchOnEnter = true;
                }
            });
        }

        function updateSuggestionSelection(items) {
            // 모든 항목의 선택 상태 초기화
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove('selected');
            }

            // 현재 선택된 항목에 선택 상태 추가
            if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < items.length) {
                items[selectedSuggestionIndex].classList.add('selected');
                items[selectedSuggestionIndex].scrollIntoView({block: 'nearest'});
            }
        }


        $(document.body).ready(function (e) {
            /*setButtonState();*/

            //yullinAuth.removeWriteButton();

            AjaxUtil.fillSelectOptions($('#factory_id'), 'factory', 'choose', false);
            AjaxUtil.fillSelectOptions($('#cboDefectType'), 'defect_type','', false);
            AjaxUtil.fillSelectOptions($('#cboStopCause'), 'stop_cause', '', false);

            $('#txtProcess').on('keypress', function (e) {
                if (event.keyCode == 13) {
                    searchMainData();
                }
            });

            // 검색버튼
            $('#btnSearch').click(function (e) {
                searchMainData();
            });

            // 신규버튼
            $('#btnNew').click(function (e) {

                $('#processForm')[0].reset();
                $('#processForm').find('#id').val('');

                $('#processForm').find('input, select').each(function () {
                    if ($(this).is(':disabled')) {
                        $(this).removeAttr('disabled');
                    }
                });

                //page.setButtonDisable(true, false, true);
                /*page.setButtonState();*/
            });

            // 저장버튼
            $('#btnSave').click(function (e) {
                saveProcess();
            });

            // 삭제버튼
            $('#btnDel').click(function (e) {
                Alert.confirm('',
                    '삭제하시겠습니까?',
                    function () {
                        deleteProcess()
                    },
                    function () {
                    }
                );
            });

            $('#btnAddDefectType').click(function () {
                //page2.newRow();
                if (!$('#cboDefectType').val()) {
                    Alert.alert('', '부적합유형을 선택해주세요.');
                    return false;
                }
                addDefectTypeRow();
            });

            $('#btnDelDefectType').click(function (e) {
                let selectedRow = theGrid2.selection.row; // 현재 선택된 행의 인덱스

                if (selectedRow >= 0) { // 선택된 행이 있는지 확인
                    // 데이터 소스 가져오기
                    let viewdata2 = theGrid2.itemsSource;

                    // 행 제거
                    viewdata2.removeAt(selectedRow);

                    saveDefectType();
                } else {
                   Alert.alert('삭제할 행을 선택하세요.');
                }
            });

            $('#btnSaveDefectType').click(function () {
                let id = $('#processForm').find('#id').val();
                if (!id) {
                    Alert.alert('', '정보를 선택해 주세요.');
                    return false;
                }
                saveDefectType();
            });


            $('#btnAddStopCause').click(function () {
                //page2.newRow();
                if (!$('#cboDefectType').val()) {
                    Alert.alert('', '부적합유형을 선택해주세요.');
                    return false;
                }
                addStopCauseRow();
            });

            $('#btnDelStopCause').click(function (e) {
                // 선택된 행 가져오기
                let selectedRow = theGrid3.selection.row; // 현재 선택된 행의 인덱스

                if (selectedRow >= 0) { // 선택된 행이 있는지 확인
                    // 데이터 소스 가져오기
                    let viewdata3 = theGrid3.itemsSource;

                    // 행 제거
                    viewdata3.removeAt(selectedRow);

                    saveStopCause();
                } else {
                    Alert.alert('삭제할 행을 선택하세요.');
                }
            });

            $('#btnSaveStopCause').click(function () {
                let id = $('#processForm').find('#id').val();
                if (!id) {
                    Alert.alert('', '정보를 선택해 주세요.');
                    return false;
                }
                saveStopCause();
            });

            document.querySelectorAll('input[type="text"]').forEach(function (input) {
                input.setAttribute('autocomplete', 'off');
            });

            const autoCompleteFields = [
                {
                    inputId: 'process_type',
                    suggestionId: 'suggestions-process_type',
                    apiUrl: '/api/definition/process/autocomplete'
                },
            ]
            autoCompleteFields.forEach(field => {
                initializeAutoComplete(field.inputId, field.apiUrl, field.suggestionId);
            });
        });

    </script>
</th:block>
</html>
