<html layout:decorate="~{layout_page}">
<style>
    /* 테이블은 고정 레이아웃으로, 셀 퍼센트가 그대로 적용되게 */
    .item-table {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
    }

    /* 셀 안 입력 요소가 셀 밖으로 안 튀게 */
    .item-table input[type="text"],
    .item-table input[type="number"],
    .item-table select {
        width: 100%;
        min-width: 0;           /* 글로벌 min-width 무력화 */
        box-sizing: border-box; /* padding+border 포함해서 100%로 계산 */
    }

    /* BOM 검색 input+버튼 정렬(버튼 다시 쓰실 경우) */
    .item-table .input-with-button {
        display: flex;
        gap: 6px;
        align-items: center;
    }
    .item-table .input-with-button input {
        flex: 1 1 auto;
        min-width: 0;           /* flex 줄어들 수 있게 */
    }

    /* 필요 시: 이 구역만 가로 스크롤 허용(임시 안전장치) */
    .section { overflow-x: auto; }

</style>
<th:block layout:fragment="content">
  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>공정별 BOM</h2>
        <a title="북마크" class="bookmark toggle">
          내 메뉴
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
        <li>기준정보</li>
        <li>공정별 BOM</li>
      </ul>
    </div>
    <div style="display: flex; gap: 5px">
      <section class="section" style="width: 50%;">
        <div class="section-top">
          <!--<div class="search-wrap">
            <dl>
              <dt>
                <label>라우팅명</label>
              </dt>
              <dd>
                <input type="text" class="form-control2" id="txtRouting" name="txtRouting">
              </dd>
            </dl>
            <dl>
              <dt><span class="eq"></span></dt>
              <dd>
                <li>
                  <a class="btn btn-delete" title="검색" id="btnSearch">
                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                    검색
                  </a>
                </li>
              </dd>
            </dl>
          </div>-->
          <div class="button-wrap">
            <ul>
              <li>
                <button type="button" class="btn-excellt btn-default" id="btnBomCompNew"
                        style="width: 115px; height: 36px;"><i
                    class="fas fa-plus"></i>등록
                </button>
              </li>

              <li>
                <button type="button" class="btn-delete btn-danger y_write_auth"
                        id="btnBomCompDelete"
                        style="width: 115px; height: 36px;"><i
                    class="fas fa-trash"></i>삭제
                </button>
              </li>

              <li>
                <button type="button" class="btn-edit btn-default" id="btnBomCompEdit"
                        style="width: 115px; height: 36px;"><i
                    class="fas fa-edit"></i>수정
                </button>
              </li>
              <li>
                <button type="button" class="btn-edit btn-default" id="btnAddBomList"
                        style="width: 115px; height: 36px;"><i
                    class="fas fa-edit"></i>Bom 불러오기
                </button>
              </li>
            </ul>
          </div>
            <table class="write-table">
            <caption style="text-align: left; margin-bottom: 8px;">bom r</caption>
            <input type="hidden" id="id" name="id"/>
            <col class="wp20">
            <col class="wp80">
            <tbody>
            <tr>
              <th>
                <label for="cboBom">BOM</label><span class="eq">*</span>
              </th>
              <td>
                <input type="text" id="cboBom" name="cboBom" style="width: 100%;"/>
              </td>
            </tr>
            <tr>
              <th>
                <label for="cboProduct">제품</label>
              </th>
              <td>
                <input type="text" id="cboProduct" name="cboProduct" style="width: 100%;" placeholder="제품" required=""/>
              </td>
            </tr>
            <tr>
              <th>
                <label for="cboRouting">라우팅</label>
              </th>
              <td>
                <input type="text" id="cboRouting" name="cboRouting" style="width: 100%;" placeholder="라우팅"/>
              </td>
            </tr>
            <tr>
              <th>
                <label for="Process">공정</label>
              </th>
              <td>
                <input type="text" id="Process" name="Process" style="width: 100%;" placeholder=""/>
              </td>
            </tr>
            <tr>
              <th>
                <label for="Material">자재</label>
              </th>
              <td>
                <input type="text" id="Material" name="Material" style="width: 100%;" placeholder=""/>
              </td>
            </tr>
            <tr>
              <th>
                <label for="Amount">수량</label>
              </th>
              <td>
                <input type="number" id="Amount" name="Amount" style="width: 100%;" placeholder=""/>
              </td>
            </tr>
            <tr>
              <th>
                <label for="vercode">버전</label>
              </th>
              <td>
                <input type="text" id="vercode" name="vercode" style="width: 100%;" placeholder="버전" />
              </td>
            </tr>

          </table>
        </div>
      </section>

      <div class="tab-wrap" style="width: 50%;">
        <ul class="tab-links">
          <li><a href="#tabs_routing">라우팅 목록</a></li>
          <li><a href="#tabs_second">공정별 BOM</a></li>
        </ul>

        <div>
          <section class="tab-item" id="tabs_routing" style="border-top-left-radius: 0;">
            <div class="section-top">

            </div>
            <div class="container-fluid">
              <div id="routing-grid" style="height: 250px;"></div>
            </div>
          </section>


          <section class="tab-item" id="tabs_second" style="border-top-left-radius: 0;">
            <div class="section-top">
              <!--<div class="button-wrap">
                <ul>
                  <li>
                    <button type="button" class="btn-excellt btn-default" id="btnNewProcess" name="btnNew"
                            style="width: 115px; height: 36px;"><i class="fas fa-plus"></i></button>
                  </li>

                  <li>
                    <button type="button" class="btn-delete btn-danger" id="btnDelProcess"
                            style="float:none; width: 115px; height: 36px;"><i class="fas fa-trash"></i>
                    </button>
                  </li>
                  <li>
                    <a class="btn btn-excell" title="수정" id="btnIndexSave">
                      저장
                    </a>
                  </li>
                </ul>
              </div>-->
            </div>

            <div class="container-fluid">
              <div id="bom-grid" style="height: 360px;"></div>
            </div>
          </section>

        </div>
      </div>
    </section>
    </div>
    <div>
      <section class="section" style="height: 250px;">
        <div class="button-wrap">
          <ul>
            <li>
              <button type="button" class="btn-excellt btn-default" id="btnBomCompSave"
                      style="width: 100px; height: 36px;"><i
                  class="fas fa-plus"></i>저장
              </button>
            </li>
          </ul>
        </div>
        <div id="item-grid" style="height: 230px;"></div>
      </section>
    </div>

  </div>
</th:block>

<th:block layout:fragment="scripts">
  <script type="text/javascript">
    class BomProcCompPage {
      constructor() {
        this.routingGrid = null;
        this.productGrid = null;
        this.bomGrid = null;
        this.itemGrid = null;
        this.selectedRoutingId = null;
        this.selectedProdId = null;
        this.procList = [];
        this.baseUrl = '/api/definition/bom_proc_comp';
        this.routingView = new wijmo.collections.CollectionView([]);
        this.bomView     = new wijmo.collections.CollectionView([]);
        this.itemView = new wijmo.collections.CollectionView([]);

        this.init();
      }

      init() {
        let _this = this;

        this.bomGrid = new wijmo.grid.FlexGrid('#bom-grid', { //bom 그리드
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'prod_grp_name', header: '제품그룹', width: 120, align: 'left'},
            {binding: 'prod_code', header: '제품코드', width: 120, align: 'center'},
            {binding: 'prod_name', header: '제품명', width: 200, align: 'left'},
            {binding: 'base_prod_qty', header: '기준생산량', width: 150, align: 'left'},
            {binding: 'bom_version', header: 'BOM버전', width: 120, align: 'left'},
            {binding: 'pc_check', header: '공정별 BOM', width: 120, align: 'left'},
          ],
          itemsSource: this.bomView, // 데이터를 설정할 배열
        });

        this.routingGrid = new wijmo.grid.FlexGrid('#routing-grid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (s, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
           /* if (e.panel.cellType === wijmo.grid.CellType.Cell) {
              let item = sender.rows[e.row].dataItem; // 현재 행의 데이터 아이템
              if (item && item.children && item.children.length > 0) {
                // 부모(그룹) 행 배경색
                e.cell.style.backgroundColor = '#f0fcf7';
              } else {
                // 자식(일반) 행 배경색
                e.cell.style.backgroundColor = '#ffffff';
              }
            }*/
          },
          columns: [
            { binding: 'routing_name', header: '라우팅명',   width: 200, align: 'left'   },
            { binding: 'proc_count',   header: '공정수',     width: 120, align: 'center' },
            { binding: 'mat_count',    header: '해당제품수', width: 140, align: 'left'   },
            { binding: 'routing_desc', header: '(반)제품코드', width: 300, align: 'left' },
          ],
          //childItemsPath: 'children',
          itemsSource: this.routingView,   // ✅ CollectionView 바인딩
        });

        this.itemGrid = new wijmo.grid.FlexGrid('#item-grid', {
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          isReadOnly: false,             // 편집 가능
          selectionMode: wijmo.grid.SelectionMode.Row,
          showMarquee: true,
          itemsSource: this.itemView,
          columns: [
            // 필요한 필드 키는 마음대로; 서버 보낼 때 매핑만 맞추면 됩니다.
            { binding: 'bom',      header: 'BOM',     width: 200, },
            { binding: 'product',  header: '제품',     width: 200 },
            { binding: 'routing',  header: '라우팅',   width: 200 },
            { binding: 'process',  header: 'Process', width: 200 },
            { binding: 'material', header: '자재',     width: 200},
            { binding: 'amount',   header: '합계',     width: 100, format: 'n2', align: 'right' },
            { binding: 'vercode',  header: '버전',     width: 100 },
            { binding: '__del__',    header: '삭제',   width: 70, isReadOnly: true },
          ],
          formatItem: (s, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
            if (e.panel === s.cells) {
              const col = s.getColumn(e.col);
              if (col.binding === '__del__') {
                e.cell.innerHTML = '<button class="btnMini btnRowDelete">삭제</button>';
              }
            }
          }
        });

        this.itemGrid.hostElement.addEventListener('click', (ev) => {
          const ht = this.itemGrid.hitTest(ev);
          if (ht.panel !== this.itemGrid.cells) return;

          const col = this.itemGrid.getColumn(ht.col).binding;
          const item = this.itemView.items[ht.row];

          if (col === '__del__') {
            this.itemView.removeAt(ht.row);
          }
        });

      }//init

      searchMainData() {
        const url = '/api/definition/bom_proc_comp/read';
        const data = {
          routing_name: $('#txtRouting').val(),
          spjangcd:sessionStorage.getItem('spjangcd'),
        };

        const fnsuccess = (result) => {
          const rows = (result && result.data) ? result.data : [];
          this.routingView.sourceCollection = rows;
          this.bomView.sourceCollection = [];
        };

        AjaxUtil.getAsyncData(url, data, fnsuccess);
      }

    }

    let page = null;

    $(document).ready(function (e) {
      page = new BomProcCompPage();

      // 검색
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

      page.searchMainData();

    });
  </script>
</th:block>
</html>
