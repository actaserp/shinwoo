<html layout:decorate="~{layout_page}">
<head>
    <style>
        #matListTb input, #matListTb textarea {
            width: 100px;
            height: 40px;
        }

    </style>
</head>
<th:block layout:fragment="content">

    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>ìˆ˜ì£¼ ë° ê³„íšëŸ‰ ë“±ë¡</h2>
                <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                    ë‚´ ë©”ë‰´
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì˜ì—… ê´€ë¦¬</li>
                <li>ìˆ˜ì£¼ ë° ê³„íšëŸ‰ ë“±ë¡</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label for="cboDateKind">
                                ê²€ìƒ‰ êµ¬ë¶„<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select id="cboDateKind" name="cboDateKind">
                                    <option value="sales">ìˆ˜ì£¼ì¼</option>
                                    <option value="delivery">ë‚©ê¸°ì¼</option>
                                </select>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            ì¡°íšŒê¸°ê°„<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="date" id="srchStartDt" name="srchStartDt">
                                    <label for="srchStartDt" class="hide">ì‹œì‘ì¼</label>
                                </li>
                                <li>
                                    <input type="date" id="srchEndDt" name="srchEndDt">
                                    <label for="srchEndDt" class="hide">ì¢…ë£Œì¼</label>
                                </li>
                            </ul>
                        </dd>
                    </dl>

                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                    <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ê²€ìƒ‰
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
                <div class="button-wrap">
                    <ul>
                        <li>
                            <a class="btn btn-excell" title="ë“±ë¡" id="btnAddNew">
                                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                                ë“±ë¡
                            </a>
                        </li>
                        <li>
                            <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">
                                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">
                                ì‚­ì œ
                            </a>
                        </li>
                        <li>
                            <a class="btn btn-edit" title="ìˆ˜ì •" id="btnEdit">
                                <img src="/images/icon/ico-edit.svg" alt="ìˆ˜ì • ì•„ì´ì½˜">
                                ìˆ˜ì •
                            </a>
                        </li>
<!--                        <li>-->
<!--                            <a class="btn" title="ì—‘ì…€ ì—…ë¡œë“œ" id="btnShowUpload">-->
<!--                                ì—‘ì…€ ì—…ë¡œë“œ-->
<!--                            </a>-->
<!--                        </li>-->
<!--                        <li>-->
<!--                            <a class="btn" title="ì–‘ì‹ ë‹¤ìš´ë¡œë“œ" id="btnDownloadTemplate">-->
<!--                                ì–‘ì‹ ë‹¤ìš´ë¡œë“œ-->
<!--                            </a>-->
<!--                        </li>-->
                    </ul>
                </div>
            </div>
            <div class="container-fluid">
                <div id="theGrid" style="height: 730px;"></div>
            </div>
            <!--        <div class="grid_box">-->

            <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
            <!--        </div>-->
        </section>
    </div>
    <script type="text/x-tmpl" id="sujuTemplate">
        <style>
            /* ì•„ì´í…œ í…Œì´ë¸” ì „ì²´ ì„¤ì • */
            .item-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
                margin-top: 10px;
            }

            /* í—¤ë” ì…€ ìŠ¤íƒ€ì¼ */
            .item-table th {
                background-color: #EDEFF5;
                text-align: center;
                font-weight: bold;
                padding: 8px;
                border: 1px solid #ccc;
            }

            /* ë°”ë”” ì…€ ìŠ¤íƒ€ì¼ */
            .item-table td {
                padding: 6px;
                text-align: center;
                border: 1px solid #ccc;
            }

            /* ì…ë ¥ í•„ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
            .item-table input {
                width: 100%;
                box-sizing: border-box;
                padding: 4px;
            }

            /* í’ˆëª© & ë¹„ê³  ì™¼ìª½ ì •ë ¬ */
            .item-table td:first-child,
            .item-table td:nth-child(6) {
                text-align: left;
            }

            /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
            .item-table .btn.in_btn {
                display: inline-flex;
                justify-content: center;
                align-items: center;
                width: 32px;
                height: 32px;
                border-radius: 4px;
                padding: 0;
                border: 1px solid #B3B3B3;
                background-color: #fff;
                cursor: pointer;
                transition: background-color 0.2s;
                line-height: 0;
            }

            /* + ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
            .item-table .btn.in_btn.plus img {
                width: 10px;
                height: 10px;
                display: block;
            }

            /* ê³µí†µ ì•„ì´ì½˜ ë²„íŠ¼ ì´ë¯¸ì§€ (ì‚­ì œ, ê²€ìƒ‰ í¬í•¨) */
            .item-table .btn.in_btn img {
                width: 12px;
                height: 12px;
                display: block;
                margin-right: 5px;
            }

            .input-with-button {
                display: flex;
                gap: 4px; /* ë²„íŠ¼ê³¼ input ì‚¬ì´ ì—¬ë°± */
                align-items: center;
            }

            .input-with-button input {
                flex: 1; /* ë‚˜ë¨¸ì§€ ì˜ì—­ ì°¨ì§€ */
                min-width: 0;
                padding: 4px;
            }

            .input-with-button .btn.in_btn {
                flex-shrink: 0;
            }

            .content_wrap.popup {
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            .table-wrap {
                flex: 1;
                overflow-y: auto;
                padding-right: 5px;
            }

            .popup-button {
                flex-shrink: 0;
                padding: 10px;
                background: #fff;
                border-top: 1px solid #ddd;
            }

            .input-with-checkbox {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .input-with-checkbox input[type="number"] {
                flex: 1;
                min-width: 0;
                padding: 4px;
            }

            .input-with-checkbox input[type="checkbox"] {
                flex-shrink: 0;
                width: 18px;
                height: 18px;
            }
        </style>
        <div class="content_wrap popup" id="div_excel_upload">
            <div class="table-wrap">
            <form id="sujuForm">
                <table class="write-table">
                    <caption>ì£¼ë¬¸ë“±ë¡ í…Œì´ë¸”</caption>
                    <input type="hidden" id="id" name="id">
                    <tbody>
                        <tr>
                            <th style="text-align: center">
                                <label for="JumunDate">ìˆ˜ì£¼ì¼*</label>
                            </th>
                            <td>
                                <input type="date" id="JumunDate" name="JumunDate">
                            </td>
                            <th style="text-align: center">
                                <label for="DueDate">ë‚©ê¸°ì¼*</label>
                            </th>
                            <td>
                                <input type="date" id="DueDate" name="DueDate">
                            </td>
                        </tr>
<!--                        <tr>-->
<!--                            <th style="text-align: center">-->
<!--                                <label for="cboCompany">í”„ë¡œì íŠ¸</label>-->
<!--                            </th>-->
<!--                            <td colspan="3">-->
<!--                                <input id="projectHidden" name="projectHidden" type="hidden">-->
<!--                                <input class="form-control2" type="text" id="project" name="project"-->
<!--                                placeholder="í”„ë¡œì íŠ¸ ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”" readonly/>-->
<!--                                &nbsp;-->
<!--                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSelect_project">-->
<!--                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">-->
<!--                                    í”„ë¡œì íŠ¸ ê²€ìƒ‰-->
<!--                                </a>-->
<!--                            </td>-->
<!--                        </tr>-->
                        <tr>
                           <th style="text-align: center">
                                <label for="cboOrder">ìˆ˜ì£¼ì²˜*</label>
                            </th>
                            <td >
                                <input id="SuJuOrderId" name="SuJuOrderId" type="hidden">
                                <input class="form-control2" type="text" id="SuJuOrderName" name="SuJuOrderName"
                                placeholder="ìˆ˜ì£¼ì²˜ ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ íŒë§¤ì²˜ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”" readonly/>
                                &nbsp;
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnOrderSearch">
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    ìˆ˜ì£¼ì²˜ ê²€ìƒ‰
                                </a>
                            </td>
                            <th style="text-align: center">
                                <label for="cboSujuType">ìˆ˜ì£¼êµ¬ë¶„</label>
                            </th>
                            <td colspan="3">
                                <select id="cboSujuType" name="SujuType"></select>
                            </td>
                        </tr>
                        <tr>
                            <th style="text-align: center">
                                <label for="cboCompany">íŒë§¤ì²˜*</label>
                            </th>
                            <td >
                                <input id="cboCompany" name="Company_id" type="hidden">
                                <input class="form-control2" type="text" id="CompanyName" name="CompanyName"
                                placeholder="íŒë§¤ì²˜ ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ íŒë§¤ì²˜ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”" readonly/>
                                &nbsp;
                                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnCompanySearch">
                                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                    íŒë§¤ì²˜ ê²€ìƒ‰
                                </a>
                            </td>
                            <th style="text-align: center">
                                <label for="delivery">ë‚©í’ˆì²˜*</label>
                            </th>
                            <td colspan="3">
                                <input class="form-control2" type="text" id="DeliveryName" name="DeliveryName" placeholder="ë‚©í’ˆì²˜"/>
                            </td>
                        </tr>
                        <tr>
                            <th style="text-align: center">
                                <label for="Description">ë¹„ê³ </label>
                            </th>
                            <td colspan="3">
                                <textarea id="Description" name="Description" style="height:40px;"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <th style="text-align: center">
                                <label for="StateName">ìƒíƒœ</label>
                            </th>
                            <td>
                                <input type="text" id="StateName" name="StateName" readonly disabled>
                            </td>
                            <th style="text-align: center">
                                <label for="totalAmountSum">ì´ì•¡</label>
                            </th>
                            <td>
                                <input id="totalAmountSum" name="totalAmountSum" style="text-align:right;" readonly>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <table class="item-table">

                    <table class="item-table">

                    <colgroup>
                        <col style="width: 6%">
                        <col style="width: 25%">
                        <col style="width: 9%">
                        <col style="width: 5%">
                        <col style="width: 13%">
                        <col style="width: 9%">
                        <col style="width: 9%">
                        <col style="width: 9%">
                        <col style="width: 11%">
                        <col style="width: 6%">
                        <col style="width: 4%">
                    </colgroup>
                    <thead>
                    <tr id="itemHeaderRow">
                        <th>ì½”ë“œ</th>
                        <th>í’ˆëª©</th>
                        <th>ê·œê²©</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ë‹¨ê°€ <span style="font-size: 13px;">(ì„ íƒì‹œ ë¶€ê°€ì„¸ í¬í•¨)</span></th>
                        <th>ê³µê¸‰ê°€ì•¡</th>
                        <th>ë¶€ê°€ì„¸</th>
                        <th>í•©ê³„</th>
                        <th>ë¹„ê³ </th>
                        <th>ìƒíƒœ</th>
                        <th>
                            <a class="btn in_btn plus" id="addRemark" title="ì¶”ê°€">
                                <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜" />
                            </a>
                        </th>
                    </tr>
                    </thead>
                    <tr class="item-template-row" style="display: none;">
                        <td>
                            <input type="text" name="product_code" placeholder="ì½”ë“œ" readonly/>
                        </td>
                        <td>
                            <div class="input-with-button">
                                <input type="hidden" name="suju_id" />
                                <input type="text" name="txtProductName" placeholder="ì½”ë“œ ë˜ëŠ” í’ˆëª… ì…ë ¥ í›„ ì—”í„°" autocomplete="off" />
                                <input type="hidden" name="MaterialGroupName" />
                                <input type="hidden" name="Material_id" />
                                <input type="hidden" name="unit" />
                                <input type="hidden" name="standard_locked">
                                <a class="btn in_btn" title="í’ˆëª© ê²€ìƒ‰" id="btnProductSearch" >
                                    <img src="/images/icon/btn-srch-black.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜" />
                                </a>
                            </div>
                        </td>
                        <td>
                            <input type="text" name="standard" placeholder="ê·œê²©" />
                        </td>
                        <td><input type="text" name="quantity" placeholder="ìˆ˜ëŸ‰" /></td>
                        <td>
                            <div class="input-with-checkbox">
                                <input type="text" name="unitPrice" placeholder="ë‹¨ê°€" />
                                <input type="hidden" name="originalUnitPrice" />
                                <input type="checkbox" name="VatIncluded" />
                            </div>
                        </td>
                        <td><input type="text" name="supplyAmount" placeholder="ê³µê¸‰ê°€ì•¡" /></td>
                        <td><input type="text" name="VatAmount" placeholder="ë¶€ê³¼ì„¸"/></td>
                        <td><input type="text" name="totalAmount" placeholder="í•©ê³„" /></td>
                        <td><input type="text" name="description" placeholder="ë¹„ê³ " /></td>
                         <td>
                            <input type="hidden" name="State"/>
                            <input type="text" name="suju_StateName" placeholder="ìƒíƒœ" readonly />
                        </td>
                        <td class="al_c item_border">
                            <a class="btn in_btn" title="ì‚­ì œ" onclick="removeItemRow(this)">
                                <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜" />
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </form>
            </div>
            <div id="notUpdate" style="display:none;">*ê³„íš ë˜ëŠ” ì¶œí•˜ê°€ ì§„í–‰ëœ ìˆ˜ì£¼ëŠ” ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</div>
            <div class="popup-button">
                    <button type="button" class="btn-popup y_write_auth" id="btnPopSujuSave">ì €ì¥</button>
                    <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
            </div>
        </div>
    </script>

    <script type="text/x-tmpl" id="excelUploadTemplate">
        <div class="content_wrap popup" id="div_excel_upload">

            <div class="table-wrap">
                <form id="excelUploadForm">
                <table class="write-table">
                    <colgroup>
                        <col style="width: 25%;">
                        <col style="width: 75%;">
                    </colgroup>
                    <tbody>
                        <tr>
                            <th style="text-align: center">
                                <label>ì¼ì</label>
                            </th>
                            <td>
                                <input style="width:300px;" type="date" id="data_date" name="data_date" value=""  />
                            </td>
                        </tr>
                        <tr>
                            <th style="text-align: center">
                                <label>ì²¨ë¶€íŒŒì¼</label>
                            </th>
                            <td>
                                <input style="width:300px; height: 44px;" type="file" id="upload_file" name="upload_file" enctype="multipart/form-data" accept=".xls, .xlsx"/>
                            </td>
                        </tr>
                    </tbody>
                </table>
                </form>
            </div>
            <div class="pt-2">
                <textarea id="upload_message" style='display:none;width:100%;height:150px;'></textarea>
            </div>

            </section>

            <div class="popup-button">
                <button type="button" class="btn-popup y_write_auth" id="btn_excel_save" >ì €ì¥</button>
                <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
            </div>
        </div>
    </script>
</th:block>

<th:block layout:fragment="scripts">
    <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
    <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <th:block th:replace="/common/popup_project :: popup_project"></th:block>

    <script type="text/javascript">

        let isInternalFormatting = false;
        class SujuUploadPage {
            constructor() {
                this.url = '/api/sales/suju';
                this.grid = null;
                this.$btnEdit = $('#btnEdit');
                this.$btnAddNew = $('#btnAddNew');
                this.viewData = new wijmo.collections.CollectionView();
                this.init();

            }

            resetSujuListIndex() {
                this.sujuListIndex = 0;
            }

            nextSujuListIndex() {
                return this.sujuListIndex++;
            }

            init() {
                let _this = this;
                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'CompanyName', header: 'íŒë§¤ì²˜', width: 150, align: 'left'},
                        {binding: 'JumunDate', header: 'ìˆ˜ì£¼ì¼', width: 120, align: 'center'},
                        {binding: 'JumunNumber', header: 'ìˆ˜ì£¼ ë²ˆí˜¸', width: 150, align: 'center'},
                        {binding: 'product_name', header: 'ì œí’ˆëª…', width: 400},
                        {binding: 'TotalPrice', header: 'ì´ì•¡', width: 120, align: 'right', format: 'n0'},
                        {binding: 'DueDate', header: 'ë‚©ê¸°ì¼', width: 120, align: 'center'},
                        {binding: 'StateName', header: 'ì‘ì—…ìƒíƒœ', width: 100, align: 'center'},
                        {binding: 'ShipmentStateName', header: 'ì¶œí•˜ìƒíƒœ', width: 100, align: 'center'},
                        {binding: 'Description', header: 'ë¹„ê³ ', width: 250}
                    ],
                    itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
                });

                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = 'ìˆ˜ì£¼ ë‚´ì—­';

                this.grid.hostElement.addEventListener('dblclick', function (e) {
                    let items = _this.grid.selectedItems;
                    if (items.length === 0) {
                        return false;
                    }
                    _this.$btnEdit.trigger('click');
                });

                let nowDate = CommonUtil.getYYYYMMDD();
                let dueDate = CommonUtil.getYYYYMMDD(10);

                //ìˆ˜ì£¼ë“±ë¡ í´ë¦­
                this.$btnAddNew.click(function (e) {
                    let defaultData = {
                        id: '',
                        mode: 'new',
                        JumunDate: nowDate,
                        DueDate: dueDate,
                    };
                    _this.showSujuForm(defaultData);
                });

                // ìˆ˜ì£¼ ìˆ˜ì • í´ë¦­
                this.$btnEdit.click(function (e) {
                    let selectedItems = _this.grid.selectedItems;
                    const it = _this.grid.selectedItems && _this.grid.selectedItems[0];

                    if (selectedItems.length === 1) {
                        window.selectedGridId = it.id;
                        let data = {
                            id: selectedItems[0].id,
                            action: 'detail'
                        };
                        let fnsuccess = function (result) {
                            result.data['mode'] = 'edit';
                            const selected = selectedItems[0];
                            // ê¸°ë³¸ ì„¤ì •
                            if (selected.StateName) {
                                result.data['StateName'] = selected.StateName;
                            }
                            if (selected.State) {
                                result.data['State'] = selected.State;
                            }

                            // ì¶œí•˜ ìƒíƒœê°€ ìˆë‹¤ë©´ ë®ì–´ì“°ê¸°
                            if (selected.ShipmentStateName) {
                                result.data['StateName'] = selected.ShipmentStateName;
                            }
                            _this.showSujuForm(result.data);
                        };
                        AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
                    } else {
                        Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }

                });

                // ì‚­ì œ ë²„íŠ¼
                $('#btnDelete').click(function (e) {
                    let items = _this.grid.selectedItems;
                    if (items.length > 0) {
                        Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                            function () {
                                let id = items[0].id;
                                let state = items[0].State;
                                let ShipmentStateName = items[0].ShipmentStateName;
                                _this.deleteSujuData(id, state, ShipmentStateName);
                            },
                            function () {
                            }
                        );
                    } else {
                        Alert.alert('', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', function () {
                            $(this).focus();
                        });
                    }
                });

                // ì—”í„°í‚¤ ê²€ìƒ‰
                $('#keyword').on('keypress', function (e) {
                    if (e.keyCode === 13) {
                        _this.searchMainData();
                    }
                });
            }

            showSujuForm(data) {

                //sujuTemplate
                let _this = this;
                let content = tmpl('sujuTemplate', data);
                let $content = $(content);

                let modalContainer = null;
                if (data.mode === 'new') {
                    modalContainer = new PopupDraggable('ë“±ë¡');
                } else {
                    modalContainer = new PopupDraggable('ìˆ˜ì •');
                }
                modalContainer.open({width: 1350, height: 600, $content});

                // ì œí’ˆê²€ìƒ‰
                let $btnProductSearch = $content.find('#btnProductSearch');
                let $sujuForm = $content.find('#sujuForm');

                let $cboSujuType = $content.find('#cboSujuType');

                if (data.mode === 'new') {
                    $btnProductSearch.removeAttr('disabled');
                }

                $content.find('#btnCompanySearch').click(function () {
                    let poppage = new PopCompComponent();
                    let $poppage = $(poppage);
                    let searchcallback = function (items) {
                        $content.find('#cboCompany').val(items.id);
                        $content.find('#CompanyName').val(items.compname);

                        // if ($Material_id.val() && $cboCompany.val()) {
                        //     tryShowPrice();
                        // }
                    };

                    poppage.show(searchcallback);
                });
                $content.find('#btnOrderSearch').click(function () {
                    let poppage = new PopCompComponent();
                    let $poppage = $(poppage);
                    let searchcallback = function (items) {
                        $content.find('#SuJuOrderId').val(items.id);
                        $content.find('#SuJuOrderName').val(items.compname);

                        $content.find('#cboCompany').val(items.id);
                        $content.find('#CompanyName').val(items.compname);

                        setTimeout(() => {
                            const $delivery = $content.find('#DeliveryName');
                            if ($delivery.length) {
                                $delivery.focus();
                                // ì»¤ì„œë¥¼ ë§¨ ë’¤ë¡œ ì´ë™(ì„ íƒ ë²”ìœ„ = ê¸¸ì´,ê¸¸ì´)
                                const el = $delivery.get(0);
                                if (el && el.setSelectionRange) {
                                    const v = $delivery.val() || '';
                                    el.setSelectionRange(v.length, v.length);
                                }
                            } else {
                                const $fallback = $('#DeliveryName');
                                if ($fallback.length) $fallback.focus();
                            }
                        }, 120);
                    };

                    poppage.show(searchcallback);
                });

                // ì €ì¥ë²„íŠ¼
                let $btnPopSujuSave = $('#btnPopSujuSave');

                //ìˆ˜ì£¼êµ¬ë¶„
                AjaxUtil.fillSelectOptions($cboSujuType, 'system_code', 'choose', 'sales', 'suju_type');

                setTimeout(() => {
                    FormUtil.BindDataSujuForm(data, $sujuForm);
                    if (data.mode === 'new') {
                        // ì‹ ê·œëŠ” ê¸°ë³¸ í•´ì œ + ê°’ë„ Nìœ¼ë¡œ ë§ì¶°ì„œ extractForm ì‹œ ëˆ„ë½ ë°©ì§€
                        $content.find('input[type="checkbox"][name^="VatIncluded"]')
                            .prop('checked', false)
                            .val('N')
                            .trigger('change'); // ê³„ì‚°ì‹ ì¦‰ì‹œ ë°˜ì˜
                    }

                    // âœ… ê·œê²© ì ê¸ˆ ì ìš©
                    $content.find('.item-table tbody tr:visible').not('.item-template-row').each(function (i) {
                        const $row = $(this);
                        const $standard = $row.find('input[type="text"][name^="standard_"]');
                        // 1) hidden í•„ë“œê°€ ìˆìœ¼ë©´ ê·¸ ê°’ ìš°ì„ (Y/N)
                        const hidden = ($row.find('input[name^="standard_locked_"]').val() || '').toString().toUpperCase();
                        // 2) ì—†ìœ¼ë©´ ì„œë²„ ì‘ë‹µ ìˆœì„œ ë§¤ì¹­(ì´ˆê¸° ë¡œë”© ì‹œì—ë§Œ ì•ˆì „)
                        const fromData = (data.sujuList?.[i]?.standard_locked || '').toString().toUpperCase();

                        let locked = (hidden === 'Y') || (hidden === '' && fromData === 'Y');

                        // ì‹ ê·œ ëª¨ë“œë¼ë©´ ë¬´ì¡°ê±´ í•´ì œ
                        if (data.mode === 'new') locked = false;

                        // âœ… ê·œê²© ì ê¸ˆ ì ìš© ë¸”ë¡ ë‚´
                        $standard.prop('readOnly', locked)
                            .toggleClass('readonly', locked)
                            .attr('data-locked', locked ? 'Y' : 'N');

                        // â† ì—¬ê¸°ê°€ ì¤‘ìš”
                        if (locked) $standard.attr('readonly', 'readonly');
                        else        $standard.removeAttr('readonly');   // âœ¨ ì¶”ê°€: attrê¹Œì§€ ì œê±°

                        // hidden í•„ë“œê°€ ìˆë‹¤ë©´ ê°’ ë™ê¸°í™”
                        const $lockedHidden = $row.find('input[name^="standard_locked_"]');
                        if ($lockedHidden.length) $lockedHidden.val(locked ? 'Y' : 'N');
                    });

                    // âœ… ê° í–‰ unitType ì„ ì„¸íŒ… (Bind ì§í›„)
                    $content.find('.item-table tbody tr:visible').not('.item-template-row').each(function (i) {
                        const $row = $(this);
                        const unitRaw = ($row.find('input[name^="unit_"]').val() || '').toString().trim().toUpperCase();
                        const fallback = (data.sujuList?.[i]?.unit || data.sujuList?.[i]?.unit_name || '').toString().trim().toUpperCase();
                        const base = unitRaw || fallback;
                        $row.data('unitType', base.startsWith('M') ? 'M' : 'EA');
                    });

                    // ìµœì´ˆ ê³„ì‚° ìˆ˜í–‰
                    $content.find('.item-table tbody tr:visible').not('.item-template-row').each(function () {
                        calculateAmounts($(this), 'unit');
                    });
                }, 100);

                if (data.StateName && data.StateName !== 'ìˆ˜ì£¼') {
                    $('#btnPopSujuSave').hide();
                    $('#notUpdate')
                        .css('margin-top', '10px') // ì¡°ê±´ ë§Œì¡± ì‹œ margin-top ì ìš©
                        .show();
                    $('.popup-button').css('margin-top', '10px');
                }

                if (data.SujuQty > 0) {
                    $SujuQty.val(data.SujuQty.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                }


                // ìˆ˜ì£¼ë“±ë¡ íŒì—… ì €ì¥ë²„íŠ¼ í´ë¦­
                $btnPopSujuSave.click(function (e) {

                    //ìˆ˜ì£¼ì¼, ë‚©ê¸°ì¼ ì²´í¬?
                    let data = FormUtil.extractForm($sujuForm);
                    console.log('ë°ì´í„° í™•ì¸:', data);

                    if (!$('#SuJuOrderName').val()) {
                        Alert.alert('', 'ìˆ˜ì£¼ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }
                    if (!$('#DeliveryName').val()) {
                        Alert.alert('', 'ë‚©í’ˆì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                        return;
                    }
                    if (!$('#cboCompany').val()) {
                        Alert.alert('', 'íŒë§¤ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }

                    if (!data.Material_id_0) {
                        Alert.alert('', 'í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }

                    // 2. ê° í–‰ì˜ ìœ íš¨ì„± ì²´í¬
                    let index = 0;
                    while (true) {
                        const materialId = data[`Material_id_${index}`];

                        if (materialId === undefined) break; // ëê¹Œì§€ ì²´í¬

                        if (materialId !== null && materialId !== '') {
                            const qty = data[`quantity_${index}`];
                            const price = data[`unitPrice_${index}`];

                            if (!qty) {
                                Alert.alert('', `(${index + 1}ë²ˆì§¸ í–‰) ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.`);
                                return;
                            }
                        }

                        index++;
                    }

                    Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                        const items = [];
                        for (let i = 0; i < page.sujuListIndex; i++) {
                            const materialId = data[`Material_id_${i}`];
                            if (!materialId) continue;

                            items.push({
                                suju_id: data[`suju_id_${i}`] || '',
                                Material_id: materialId,
                                MaterialGroupName: data[`MaterialGroupName_${i}`] || '',
                                product_code: data[`product_code_${i}`] || '',
                                txtProductName: data[`txtProductName_${i}`] || '',
                                quantity: (data[`quantity_${i}`] || '0').replace(/,/g, ''),
                                unitPrice: (data[`unitPrice_${i}`] || '0').replace(/,/g, ''),
                                supplyAmount: (data[`supplyAmount_${i}`] || '0').replace(/,/g, ''),
                                VatAmount: data[`VatAmount_${i}`] === 'ë©´ì„¸' ? '0' : (data[`VatAmount_${i}`] || '0').replace(/,/g, ''),
                                totalAmount: (data[`totalAmount_${i}`] || '0').replace(/,/g, ''),
                                description: data[`description_${i}`] || '',
                                VatIncluded: data[`VatIncluded_${i}`] === 'on' ? 'Y' : 'N',
                                projectHidden: data[`projectHidden_${i}`] || '',
                                unitPriceChanged: (() => {
                                    const ori = parseFloat(data[`originalUnitPrice_${i}`] || '0');
                                    const cur = parseFloat((data[`unitPrice_${i}`] || '0').replace(/,/g, ''));
                                    return ori !== cur;
                                })(),
                                standard : data[`standard_${i}`] || ''
                            });
                        }


                        // ê³µí†µ ì •ë³´ + ë¦¬ìŠ¤íŠ¸ ì „ì†¡
                        const payload = {
                            id: data.id,
                            JumunDate: data.JumunDate,
                            DueDate: data.DueDate,
                            Company_id: data.Company_id,
                            CompanyName: data.CompanyName,
                            SujuType: data.SujuType,
                            spjangcd: data.spjangcd,
                            totalAmountSum: data.totalAmountSum,
                            Description: data.Description,
                            order_id:data.SuJuOrderId,
                            OrderName:data.SuJuOrderName,
                            DeliveryName:data.DeliveryName ,
                            items: items
                        };

                        AjaxUtil.postJsonData(_this.url + '/manual_save', payload, function (res) {
                            if (res.success) {
                                Notify.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                _this.searchMainData();
                                modalContainer.close();
                            } else {
                                Alert.alert('ì €ì¥ ì‹¤íŒ¨', res.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                            }
                        });

                    });

                });

                // ë‹¨ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                function tryShowPrice($row) {
                    const mat_pk = $row.find('input[name^="Material_id_"]').val();
                    const company_id = $content.find('#cboCompany').val();
                    const JumunDate = $content.find('#JumunDate').val();
                    const SujuQty = parseFloat($row.find('input[name^="quantity"]').val().replace(/,/g, '') || '0');

                    let url = _this.url + '/readPriceSuju';
                    let data = {
                        'mat_pk': mat_pk,
                        'company_id': company_id,
                        'JumunDate': JumunDate
                    };

                    if (mat_pk && company_id && JumunDate) {

                        let fnsuccess = function (result) {

                            let unitPrice = 0;
                            if (result != null && result.data && result.data.length > 0) {
                                unitPrice = parseFloat(result.data[0].UnitPrice);
                                $row.find('input[name^="unitPrice_"]').val(unitPrice.toLocaleString());
                                $row.find('input[name^="originalUnitPrice_"]').val(unitPrice.toLocaleString());

                            } else {
                                $row.find('input[name^="unitPrice"]').val('0');
                                $row.find('input[name^="originalUnitPrice"]').val('0');
                            }
                            // ğŸ”§ unitTypeì´ ë¹„ì–´ìˆìœ¼ë©´ unit_ì—ì„œ ë³´ì •(EA/Më§Œ)
                            if (!$row.data('unitType')) {
                                const unitNameRaw = ($row.find('input[name^="unit_"]').val() || '')
                                    .toString().trim().toUpperCase();
                                $row.data('unitType', unitNameRaw.startsWith('M') ? 'M' : 'EA');
                            }

                            // âœ… ë‹¨ê°€ ë°˜ì˜ ì§í›„, ë¶„ê¸° ê³„ì‚° ê°•ì œ
                            calculateAmounts($row, 'unit');
                        };

                        AjaxUtil.getAsyncData(url, data, fnsuccess);
                    }
                }

                // ë¹ˆ ê°’ì€ í•­ìƒ ìˆ«ì 0ìœ¼ë¡œ ì²˜ë¦¬
                function getNumericValue($input, def = 0) {
                    if ($input.length === 0) return def;
                    const raw = (($input.val() || '') + '').replace(/[^0-9.]/g, '').trim();
                    if (raw === '') return def;
                    const n = parseFloat(raw);
                    return Number.isFinite(n) ? n : def;
                }

                let isInternalFormatting = false;

                function calculateAmounts($row, source = null) {
                    if (isInternalFormatting) return;
                    isInternalFormatting = true;

                    try {
                        const quantity   = getNumericValue($row.find('input[name^="quantity_"]'), 0);
                        const unitPrice  = getNumericValue($row.find('input[name^="unitPrice_"]'), 0);
                        const $standard = $row.find('input[type="text"][name^="standard_"]');
                        const standard  = getNumericValue($standard, 0); // â† ìˆ«ì(ë¯¸í„°)

                        // ë‹¨ìœ„ íŒì •: "M(ë¯¸í„°)" / "m" / "ë¯¸í„°" ëª¨ë‘ í—ˆìš©
                        const unitFieldRaw = (($row.find('input[name^="unit_"]').val() || '') + '').trim();
                        const unitType = (/^M(\b|\()|ë¯¸í„°/i).test(unitFieldRaw) ? 'M' : 'EA';
                        /*console.table([{
                            unitField: (($row.find('input[name^="unit_"]').val() || '') + '').trim(),
                            unitType,
                            standard,
                            quantity,
                            unitPrice,
                            effectiveQty: (unitType === 'M') ? (standard * quantity) : quantity
                        }]);*/

                        // Mì¸ë° ê·œê²©ì´ ë¹„ì—ˆê±°ë‚˜ 0ì´ë©´ 1ë¡œ ê°„ì£¼(ì›ì¹˜ ì•Šìœ¼ë©´ ê²½ê³  í›„ return ì²˜ë¦¬)
                        const stdForCalc = (unitType === 'M') ? (standard > 0 ? standard : 1) : 1;

                        const isVatIncluded = $row.find('input[name^="VatIncluded_"]').is(':checked');
                        const isVatExempt   = false;

                        let supplyAmount = getNumericValue($row.find('input[name^="supplyAmount_"]'), 0);
                        let vatAmount    = getNumericValue($row.find('input[name^="VatAmount_"]'), 0);
                        const isSupplyEdited = $row.data('supplyEdited') === true;
                        const isVatEdited    = $row.data('vatEdited') === true;

                        // âœ… í•µì‹¬: M â†’ (ê·œê²© Ã— ìˆ˜ëŸ‰) Ã— ë‹¨ê°€, EA â†’ (ìˆ˜ëŸ‰ Ã— ë‹¨ê°€)
                        const effectiveQty = (unitType === 'M') ? (stdForCalc * quantity) : quantity;

                        // ìë™ê³„ì‚°: ë‹¨ê°€/ìˆ˜ëŸ‰/ê·œê²©/ë¶€ê°€ì„¸ì²´í¬ ë³€ê²½ or ì‚¬ìš©ìê°€ ê¸ˆì•¡ì¹¸ ì§ì ‘ ìˆ˜ì • ì•ˆí–ˆì„ ë•Œ
                        const shouldAuto = (source === 'unit') || (!isSupplyEdited && !isVatEdited);
                        if (shouldAuto) {
                            const total = effectiveQty * unitPrice;

                            if (isVatExempt) {
                                supplyAmount = total;            // ë©´ì„¸
                                vatAmount = 0;
                            } else if (isVatIncluded) {
                                supplyAmount = Math.round(total / 1.1); // ë¶€ê°€ì„¸ í¬í•¨ê°€ â†’ ê³µê¸‰ê°€ ì—­ì‚°
                                vatAmount = total - supplyAmount;
                            } else {
                                supplyAmount = total;                  // ë¶€ê°€ì„¸ ë³„ë„
                                vatAmount = Math.floor(supplyAmount * 0.1);
                            }

                            if (!isSupplyEdited) $row.find('input[name^="supplyAmount_"]').val(supplyAmount.toLocaleString());
                            if (!isVatEdited)    $row.find('input[name^="VatAmount_"]').val(isVatExempt ? 'ë©´ì„¸' : vatAmount.toLocaleString());
                        }

                        // í•©ê³„(0ë„ "0"ìœ¼ë¡œ í‘œì‹œ)
                        const sNum = getNumericValue($row.find('input[name^="supplyAmount_"]'), 0);
                        const vNum = getNumericValue($row.find('input[name^="VatAmount_"]'), 0);
                        $row.find('input[name^="totalAmount_"]').val((sNum + vNum).toLocaleString());

                        // í‘œì‹œ í¬ë§·(ìˆ˜ëŸ‰/ë‹¨ê°€)
                        $row.find('input[name^="quantity_"]').val(quantity.toLocaleString());
                        $row.find('input[name^="unitPrice_"]').val(unitPrice.toLocaleString());

                        calculateTotalSum();
                    } finally {
                        isInternalFormatting = false; // ì—ëŸ¬ ë‚˜ë„ í”Œë˜ê·¸ ë³µêµ¬
                    }
                }

                function calculateTotalSum() {
                    let sum = 0;

                    $content.find('tr:visible').each(function () {
                        const $row = $(this);
                        const $totalInput = $row.find('input[name^="totalAmount_"]');

                        const raw = ($totalInput.val() || '').replace(/[^0-9.]/g, '').trim();
                        if (raw !== '') {
                            const total = parseFloat(raw);
                            if (!isNaN(total)) {
                                sum += total;
                            }
                        }
                    });

                    $content.find('#totalAmountSum').val(sum > 0 ? sum.toLocaleString() : '');
                }


                // ìˆ˜ëŸ‰/ë‹¨ê°€ ì…ë ¥ ì‹œ
                $content.on('input', 'input[name^="quantity_"], input[name^="unitPrice_"]', function () {
                    const $row = $(this).closest('tr');
                    $row.removeData('supplyEdited');
                    $row.removeData('vatEdited');
                    calculateAmounts($row, 'unit');
                });

                // ê³µê¸‰ê°€ ì…ë ¥
                $content.on('input', 'input[name^="supplyAmount_"]', function () {
                    const $row = $(this).closest('tr');
                    $row.data('supplyEdited', true);
                    calculateAmounts($row);
                });

                // ì„¸ì•¡ ì…ë ¥
                $content.on('input', 'input[name^="VatAmount_"]', function () {
                    const $row = $(this).closest('tr');
                    $row.data('vatEdited', true);
                    calculateAmounts($row);
                });

                // í•©ê³„ ì§ì ‘ ì…ë ¥ ì‹œ ì´í•© ê³„ì‚°
                $content.on('input', 'input[name^="totalAmount_"]', function () {
                    calculateTotalSum();
                });

                // ë¶€ê°€ì„¸ ì²´í¬ ë³€ê²½
                $content.on('change', 'input[name^="VatIncluded_"]', function () {
                    const $row = $(this).closest('tr');
                    $(this).val(this.checked ? 'Y' : 'N');
                    $row.removeData('supplyEdited');
                    $row.removeData('vatEdited');
                    calculateAmounts($row, 'unit');
                });

                // í‘œì¤€ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì¬ê³„ì‚°
                $content.on('input change', 'input[name^="standard_"]', function () {
                    const $row = $(this).closest('tr');
                    calculateAmounts($row, 'unit'); // â† 'standard-change' ë§ê³  'unit'ìœ¼ë¡œ
                });

                // ìˆ«ì í¬ë§· (input ì¤‘ formatting)
                $content.on('input', 'input[name^="quantity_"], input[name^="unitPrice_"], input[name^="supplyAmount_"], input[name^="VatAmount_"], input[name^="totalAmount_"]', function () {
                    if (isInternalFormatting) return;
                    isInternalFormatting = true;

                    const $this = $(this);
                    const input = this;
                    const raw = $this.val().replace(/[^0-9]/g, '');
                    const cursor = input.selectionStart;
                    const prevLength = input.value.length;

                    if (raw === '') {
                        $this.val('');
                    } else {
                        const formatted = Number(raw).toLocaleString();
                        $this.val(formatted);

                        const diff = formatted.length - prevLength;
                        input.setSelectionRange(cursor + diff, cursor + diff);
                    }

                    isInternalFormatting = false;
                });

                // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—…
                $content.on('click', 'a[title="í’ˆëª© ê²€ìƒ‰"]', function () {
                    const $row = $(this).closest('tr');

                    const $productInput = $row.find('input[name^="txtProductName_"]');
                    const $productId = $row.find('input[name^="Material_id_"]');
                    const $productCode = $row.find('input[name^="product_code_"]');
                    const $materialGroup = $row.find('input[name^="MaterialGroupName_"]');
                    const $Standard = $row.find('input[name^="standard_"]');
                    const $unit_name = $row.find('input[name^="unit_"]');

                    const pop = new PopMatComponent();
                    pop.material_type = 'product,sangpum';

                    pop.show(function (item) {
                        $productInput.val(item.Name);
                        $productId.val(item.id);
                        $productCode.val(item.Code);
                        $materialGroup.val(item.group_name);
                        $unit_name.val(item.unit_name);
                        $Standard.val(item.Spec);
                        if (item.Spec) {
                            $Standard.prop('readonly', true);   // ê°’ì´ ìˆìœ¼ë©´ readonly
                        } else {
                            $Standard.prop('readonly', false);  // ê°’ì´ ì—†ìœ¼ë©´ í•´ì œ
                        }
                        const unitRaw = ($unit_name.val() || '').toString().trim().toUpperCase();
                        const normalized = unitRaw.startsWith('M') ? 'M' : 'EA';
                        $row.data('unitType', normalized);

                        tryShowPrice($row);
                    });


                });

                $content.on('keydown', 'input[name^="txtProductName_"]', function (e) {
                    if (e.key !== 'Enter' && e.keyCode !== 13) return;

                    e.preventDefault();

                    const $field = $(this);
                    const $row = $field.closest('tr');

                    const $productInput = $row.find('input[name^="txtProductName_"]');
                    const $productId = $row.find('input[name^="Material_id_"]');
                    const $productCode = $row.find('input[name^="product_code_"]');
                    const $Standard = $row.find('input[name^="standard_"]');
                    const $unit_name = $row.find('input[name^="unit_"]');

                    const keyword = $field.val().trim();
                    const pop = new PopMatComponent();
                    pop.material_type = 'product,sangpum';

                    const callback = function (item) {
                        $productId.val(item.id || '');
                        $productInput.val(item.Name || '');
                        $productCode.val(item.Code || '');
                        $unit_name.val(item.unit_name || '');
                        $Standard.val(item.Spec || '');
                        if (item.Spec) {
                            $Standard.prop('readonly', true);   // ê°’ì´ ìˆìœ¼ë©´ readonly
                        } else {
                            $Standard.prop('readonly', false);  // ê°’ì´ ì—†ìœ¼ë©´ í•´ì œ
                        }
                        const unitRaw = ($unit_name.val() || '').toString().trim().toUpperCase();
                        const normalized = unitRaw.startsWith('M') ? 'M' : 'EA';
                        $row.data('unitType', normalized);

                        tryShowPrice($row);
                    };

                    if (!keyword) {
                        pop.focusAfterClose = $field[0];
                        pop.show(callback);
                        return;
                    }

                    const data = {
                        keyword: keyword,
                        spjangcd: sessionStorage.getItem('spjangcd')
                    };

                    const result = AjaxUtil.getSyncData('/api/popup/search_material', data);
                    const rows = result?.data || [];

                    if (rows.length === 1) {
                        callback(rows[0]);
                    } else {
                        pop.show(callback);
                        setTimeout(() => {
                            pop.$keyword.val(keyword);
                            pop.$btnMaterialSearch.trigger('click');
                        }, 50);
                    }
                });

                // í’ˆëª©ëª… ì§€ìš°ë©´ ì½”ë“œë“¤ë„ ê°™ì´ ì§€ì›Œì§€ê²Œ
                $content.on('input', 'input[name^="txtProductName_"]', function () {
                    const $field = $(this);
                    const $row = $field.closest('tr');

                    const $productId = $row.find('input[name^="Material_id_"]');
                    const $productCode = $row.find('input[name^="product_code_"]');
                    const $Standard = $row.find('input[name^="standard_"]');
                    const $unit_name = $row.find('input[name^="unit_"]');

                    if ($field.val().trim() === '') {
                        // ê°’ì´ ë¹„ì—ˆì„ ê²½ìš° ì—°ê´€ëœ í•„ë“œ ì´ˆê¸°í™”
                        $productId.val('');
                        $productCode.val('');
                        $Standard.val('');
                        $unit_name.val('');
                        $Standard.prop('readonly', false);
                    }
                });


                // í”„ë¡œì íŠ¸ íŒì—… ì—´ê¸°
                $content.on('keydown', 'input[name^="project_"]', function (e) {
                    if (e.key !== 'Enter' && e.keyCode !== 13) return;

                    e.preventDefault();

                    const $field = $(this);
                    const $row = $field.closest('tr');

                    const keyword = $field.val().trim();
                    const pop = new PopProjectComponent();

                    const callback = function (item) {
                        $row.find('input[name^="projectHidden_"]').val(item.projno || '');
                        $row.find('input[name^="project_"]').val(item.projnm || '');
                    };

                    if (!keyword) {
                        pop.focusAfterClose = $field[0];
                        pop.show(callback);
                        return;
                    }

                    const data = {
                        srchName: keyword,
                        spjangcd: sessionStorage.getItem('spjangcd')
                    };

                    const result = AjaxUtil.getSyncData('/api/popup/search_project', data);
                    const rows = result?.data || [];

                    if (rows.length === 1) {
                        callback(rows[0]);
                    } else {
                        pop.show(callback);
                        setTimeout(() => {
                            pop.$srchName.val(keyword);
                            pop.$btnSearch.trigger('click');
                        }, 50);
                    }
                });

                $content.find('#addRemark').click(function () {
                    const $tbody = $content.find('.item-table tbody');
                    const $template = $tbody.find('.item-template-row');

                    for (let i = 0; i < 3; i++) {
                        const $newRow = $template.clone().removeClass('item-template-row').show();
                        const index = page.nextSujuListIndex();
                        $newRow.find('input').each(function () {
                            const baseName = $(this).attr('name');
                            if (baseName) {
                                $(this).attr('name', `${baseName}_${index}`);
                            }
                        });

                        $newRow.find('a[title="ì‚­ì œ"]').attr('id', `btnDelItem_${index}`);
                        $tbody.append($newRow);
                    }
                });

                // í¬ì»¤ìŠ¤ ìë™ ì´ë™: Enter + ë°©í–¥í‚¤(â†â†’â†‘â†“)
                $content.on('keydown', 'input', function (e) {
                    const key = e.key;

                    if (!['Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) return;
                    e.preventDefault();

                    const $input = $(this);
                    const $row = $input.closest('tr');
                    const nameAttr = $input.attr('name') || '';

                    const focusOrder = [
                        'txtProductName_',
                        'standard_',
                        'quantity_',
                        'unitPrice_',
                        'supplyAmount_',
                        'VatAmount_',
                        'totalAmount_',
                        'project_',
                        'description_',
                    ];

                    const currentIndex = focusOrder.findIndex(prefix => nameAttr.startsWith(prefix));
                    if (currentIndex === -1) return;

                    let $nextInput = null;

                    // â†”ï¸ ì¢Œìš° ì´ë™
                    if (key === 'ArrowRight' && currentIndex < focusOrder.length - 1) {
                        const nextPrefix = focusOrder[currentIndex + 1];
                        $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
                    } else if (key === 'ArrowLeft' && currentIndex > 0) {
                        const prevPrefix = focusOrder[currentIndex - 1];
                        $nextInput = $row.find(`input[name^="${prevPrefix}"]`);
                    }

                    // â†•ï¸ ìƒí•˜ ì´ë™
                    if (key === 'ArrowDown' || key === 'ArrowUp') {
                        const $targetRow = key === 'ArrowDown'
                            ? $row.nextAll('tr:visible').first()
                            : $row.prevAll('tr:visible').first();

                        const allowAutoAdd = ['txtProductName_', 'description_'];
                        const isAllowedField = allowAutoAdd.some(prefix => nameAttr.startsWith(prefix));

                        // â¬‡ï¸ ë°©í–¥í‚¤ + í˜„ì¬ í–‰ì´ ë§ˆì§€ë§‰ + í—ˆìš©ëœ í•„ë“œì¼ ê²½ìš° â†’ í–‰ ìë™ ì¶”ê°€
                        if (key === 'ArrowDown' && !$targetRow.length && isAllowedField) {
                            $content.find('#addRemark').trigger('click');

                            setTimeout(() => {
                                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                                const $newRow = $rows.last();
                                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                                if ($newInput.length) $newInput.focus().select();
                            }, 50);
                            return;
                        }
                        // ì¼ë°˜ ìƒí•˜ ì´ë™
                        $nextInput = $targetRow.find(`input[name^="${focusOrder[currentIndex]}"]`);
                    }

                    // â†µ Enter í‚¤: í˜„ì¬ í–‰ ë‚´ ë‹¤ìŒ í•„ë“œ
                    if (key === 'Enter' && currentIndex < focusOrder.length - 1) {
                        const nextPrefix = focusOrder[currentIndex + 1];
                        $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
                    } else if (key === 'Enter' && nameAttr.startsWith('description_')) {
                        const $nextRow = $row.nextAll('tr:visible').first();
                        if (!$nextRow.length) {
                            //console.log('ë‹¤ìŒ í–‰ ì—†ìŒ. í–‰ ìë™ ì¶”ê°€ íŠ¸ë¦¬ê±°.');
                            $content.find('#addRemark').trigger('click');

                            setTimeout(() => {
                                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                                const $newRow = $rows.last();
                                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                                if ($newInput.length) $newInput.focus().select();
                            }, 50);
                            return;
                        } else {
                            $nextInput = $nextRow.find('input[name^="txtProductName_"]');
                        }
                    }

                    if ($nextInput && $nextInput.length) {
                        $nextInput.focus().select();
                    }
                });

            }
            deleteSujuData(id, state, ShipmentStateName) {
                let _this = this;
                let url = _this.url + '/delete';
                let data = {'id': id, 'State': state, 'ShipmentStateName': ShipmentStateName}
                let fnsuccess = function (res) {
                    if (res.success) {
                        Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        _this.searchMainData();
                    } else {
                        Alert.alert('', res.message);
                    }
                };

                AjaxUtil.postAsyncData(url, data, fnsuccess);
            }

            // exportExcel() {
            //     var targetview = this.grid;
            //     targetview.exportExcel('ìˆ˜ì£¼ë‚´ì—­.xls');
            // }

            searchMainData() {
                let _this = this;
                let date_kind = $('#cboDateKind').val();
                let start = $('#srchStartDt').val();
                let end = $('#srchEndDt').val();
                let url = this.url + '/read';

                let data = {
                    'date_kind': date_kind,
                    'start': start,
                    'end': end,
                    'action': 'read'
                };

                let fnsuccess = function (result) {
                    if (result != null) {
                        _this.viewData.sourceCollection = result.data;

                        if (window.selectedGridId) {
                            GridUtil.selectRowById(_this.grid, window.selectedGridId);
                            window.selectedGridId = null;
                        }
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);

            }

            // ì—‘ì…€ ì—…ë¡œë“œ ë²„íŠ¼
            showPopupExcelUpload(data) {
                let _this = this;
                let content = tmpl('excelUploadTemplate', data);
                let $content = $(content);
                $content.find('#data_date').val(data.data_date);
                $content.find('#day_index').val(data.day_index);

                //íŒì—…ê³µí†µëª¨ë“ˆ
                let modalContainer = new PopupDraggable('ì—‘ì…€ ì—…ë¡œë“œ');
                modalContainer.open({width: 440, height: 220, $content});


                $content.find('#btn_excel_save').on('click', function () {
                    let $form = $content.find('#excelUploadForm');
                    Alert.confirm('',
                        'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                        function () {
                            _this.saveSujuBulkData($form, modalContainer);
                            //modalContainer.close();
                        },
                        function () {
                        }
                    );
                });
            }

            // ì—‘ì…€ ì—…ë¡œë“œ ì €ì¥
            saveSujuBulkData($form, modalContainer) {
                let _this = this;
                var form = $('#excelUploadForm')[0];
                var formData = new FormData(form);

                formData['data_date'] = $('#srchStartDt').val();
                formData.append("uploadfile", $('#upload_file')[0].files[0].name);

                let result = AjaxUtil.postFileSyncData(_this.url + '/upload_save', formData);

                if (result) {
                    let message = 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    if (result.success) {
                        Notify.success(message);
                        _this.searchMainData();
                        modalContainer.close();
                    } else {

                        Alert.alert('', result.message);

                        /*let $divMessage = modalContainer.$content.find('#upload_message');
                        $divMessage.text(JSON.stringify(result.error_items));
                        $divMessage.show();*/
                    }
                }

            }

            downloadExcelForm() {
                let _this = this;
                //let url = '/api/files/mes_form?action=suju_upload';
                let fileName = "ìˆ˜ì£¼ì—…ë¡œë“œì–‘ì‹.xlsx";
                let url = '/api/files/mes_form?file_name=' + fileName;
                /*
                let data = {
                    //'tableName' : tableName,
                    'file_name': "ìˆ˜ì£¼ì—…ë¡œë“œì–‘ì‹.xlsx",
                };
                */
                AjaxUtil.downloadFile(url, fileName);
            }

        }

        //í–‰ ì‚­ì œ í•¨ìˆ˜
        function removeItemRow(el) {
            const $tbody = $(el).closest('tbody');
            const $rows = $tbody.find('tr:not(.item-template-row)');
            const $targetRow = $(el).closest('tr');

            if ($rows.length <= 3) {
                // ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì´ˆê¸°í™”ë§Œ í•˜ê³  ë¦¬í„´
                const hasData = $targetRow.find('input[type="text"], input[type="number"]').filter(function () {
                    return $(this).val().trim() !== '';
                }).length > 0;

                if (hasData) {
                    $targetRow.find('input[type="text"], input[type="number"]').val('');
                    // hidden ê°’ë„ ì´ˆê¸°í™”í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì¶”ê°€
                    $targetRow.find('input[type="hidden"]').val('');
                }

                return;
            }

            // 4ê°œ ì´ìƒì´ë©´ ì •ìƒ ì‚­ì œ
            $targetRow.remove();
        }


        let page = null;

        $(document).ready(function (e) {

            page = new SujuUploadPage();


            $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
            $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

            page.searchMainData();


            // ê²€ìƒ‰
            $('#btnSearch').click(function (e) {
                page.searchMainData();
            });

            // ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
            $('#btnDownloadTemplate').click(function (e) {
                page.downloadExcelForm();
            });

            // ì—‘ì…€ ì—…ë¡œë“œ ë²„íŠ¼
            $('#btnShowUpload').click(function (e) {
                let data = {
                    'id': '',
                    'data_date': CommonUtil.getYYYYMMDD(),
                };
                page.showPopupExcelUpload(data);
            });

        })


    </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>